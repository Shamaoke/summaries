---
title: Ecryptfs
---


#Содержание
{: id="Содержание"}

[Глоссарий](#Глоссарий)

[Инструментарий](#Инструментарий)

Для создания зашифрованного тома Ecryptfs необходимо использовать пользовательские утилиты из пакета [_ecryptfs-utils_](#ecryptfs-utils).

Порядок создания зашифрованного раздела следующий:

1\. Загрузить модуль ядра _ecryptfs_

  `modprobe ecryptfs` или создать файл _ecryptfs.conf_ в _/etc/modprobe.d/_, добавив в него имя загружаемого модуля (_ecryptfs_). Во втором случае, модуль загрузится автоматически при следующем запуске.

2\. Сгенерировать случайный [пароль монтирования](#wrapped_passphrase)

3\. Придумать [пароль для контейнера](#wrapping_passphrase)

4\. Упаковать пароль монтирования в криптографический контейнер задав для него пароль для контейнера

  `ecryptfs-wrap-passphrase`

5\. Добавить пароль монтирования в ключницу, сохранив [подпись ключа монтирования](). Данная подпись впоследствии будет использована вместо пароля в конфигурационных файлах

  `ecryptfs-insert-wrapped-passphrase-into-keyring`

6\. Создать каталог, где будут храниться зашифрованные файлы

  `mkdir -m 700 .data-lower`

7\. Создать каталог доступа к зашифрованным файлам, которые станут доступны после монтирования зашифрованного каталога

  `mkdir -m 500 .data-upper`

8\. Добавить в _/etc/fstab_ следующее

  `/home/user/.data-lower /home/user/.data-upper ecryptfs noauto,user,ecryptfs_sig=16242358f0079dd6,ecryptfs_fnek_sig=16242358f0079dd6,ecryptfs_cypher=blowfish,ecryptfs_key_bytes=32,ecryptfs_unlink_sigs 0 0`

  _noauto_: не монтировать том автоматически; без этой опции systemd попытается смонтировать том при загрузке и вернет ошибку, т. к. зашифрованные тома монтируются вручную

  _user_: разрешить пользователю монтировать том

  _ecryptfs_sig_: подпись ключа монтирования

  _ecrypts_fnek_sig_: „filename encryption key signature“, подпись ключа для шифрования файловых имен

  _ecryptfs_cypher_: алгоритм шифрования

  _ecryptfs_key_bytes_: размер ключа шифрования

  _ecryptfs_unlink_sigs_: удалять пароль монтирования из ключницы при размонтировании тома

9\. Смонтировать том командой `mount -i ~/.data-upper` (пароль монтирования должен находиться в ключнице)

  Добавляемые файлы в каталог _~/.data-upper_ будут зашифрованы и добавлены в каталог _~/.data-lower_. При размонтировании _~/.data-upper_, все файлы из него исчезнут, но их зашифрованные дубликаты останутся в _~/.data-lower_.

10\. Размонтировать том командой `umount ~/.data-upper`. Пароль монтирования будет удален из ключницы и потребует повторного добавления при последующем монтировании тома.

#Глоссарий
{: id="Глоссарий"}

**stacked cryptographic file system**

файловая система, устанавливаемая поверх уже существующей

**wrapped passphrase**
{: id="wrapped_passphrase"}

упакованный пароль

**wrapping passphrase**
{: id="wrapping_passphrase"}

пароль упаковщика

#Инструментарий
{: id="Инструментарий"}

**ecryptfs-utils**
{: id="ecryptfs-utils"}

Набор утилит для работы с ФС Ecryptfs.

**ecryptfs-wrap-passphrase**

`printf "%s\n%s" "mount_passphrase" "wrapping_passphrase" | ecryptfs-wrap-passphrase $HOME/.ecryptfs/wrpapped-passphrase -`

Упаковать пароль монтирования.

**keyctl**

`keyctl list @u`

Показать хранимые в ключнице пароли для текущего пользователя

**keyutils**

**modprobe**

Утилита загрузки модулей ядра. Используется для загрузки модуля _ecryptfs_.
